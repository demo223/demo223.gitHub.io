(window.webpackJsonp=window.webpackJsonp||[]).push([[168],{453:function(t,s,e){"use strict";e.r(s);var a=e(14),n=Object(a.a)({},(function(){var t=this,s=t._self._c;return s("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[s("h1",{attrs:{id:"事务"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#事务"}},[t._v("#")]),t._v(" 事务")]),t._v(" "),s("h2",{attrs:{id:"事务简介"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#事务简介"}},[t._v("#")]),t._v(" 事务简介")]),t._v(" "),s("p",[t._v("事务 是一组操作的集合，它是一个不可分割的工作单位，事务会把所有的操作作为一个整体一起向系统提交或撤销操作请求，即这些操作要么同时成功，要么同时失败。")]),t._v(" "),s("p",[t._v("就比如: 张三给李四转账1000块钱，张三银行账户的钱减少1000，而李四银行账户的钱要增加 1000。 这一组操作就必须在一个事务的范围内，要么都成功，要么都失败。")]),t._v(" "),s("p",[t._v("转账前，张三和李四的账户余额信息")]),t._v(" "),s("table",[s("thead",[s("tr",[s("th",{staticStyle:{"text-align":"center"}},[t._v("id")]),t._v(" "),s("th",{staticStyle:{"text-align":"center"}},[t._v("name")]),t._v(" "),s("th",{staticStyle:{"text-align":"center"}},[t._v("money")])])]),t._v(" "),s("tbody",[s("tr",[s("td",{staticStyle:{"text-align":"center"}},[t._v("1")]),t._v(" "),s("td",{staticStyle:{"text-align":"center"}},[t._v("张三")]),t._v(" "),s("td",{staticStyle:{"text-align":"center"}},[t._v("5000")])]),t._v(" "),s("tr",[s("td",{staticStyle:{"text-align":"center"}},[t._v("2")]),t._v(" "),s("td",{staticStyle:{"text-align":"center"}},[t._v("李四")]),t._v(" "),s("td",{staticStyle:{"text-align":"center"}},[t._v("5000")])])])]),t._v(" "),s("p",[t._v("正常情况：")]),t._v(" "),s("p",[t._v("​\t\t 转账这个操作，需要分为以下这么三步来完成，三步完成之后, 张三减少1000， 而李四 增加1000，转账成功。")]),t._v(" "),s("ol",[s("li",[t._v("查询张三的账户余额")]),t._v(" "),s("li",[t._v("张三账户余额减少1000")]),t._v(" "),s("li",[t._v("李四查询账户余额增加1000")])]),t._v(" "),s("p",[t._v("异常情况：")]),t._v(" "),s("p",[t._v("​\t\t  在执行第三步的时候报错了，这样就导致张三减少了1000块钱但是李四没有收到钱。")]),t._v(" "),s("p",[t._v("为了解决上述问题就需要通过数据的事务来完成，我们只需要在业务逻辑执行之前开启事务，执行 完毕后提交事务。如果执行过程中报错，则回滚事务，把数据恢复到事务开始之前的状态。")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://raw.githubusercontent.com/demo223/pictures/master/img/image-20221103224115640.png",alt:"image-20221103224115640"}})]),t._v(" "),s("blockquote",[s("p",[t._v("注意： 默认"),s("code",[t._v("MySQL")]),t._v("的事务是"),s("strong",[t._v("自动提交")]),t._v("的，也就是说，当执行完一条DML语句时，MySQL会立即隐 式的提交事务。")])]),t._v(" "),s("h2",{attrs:{id:"事务操作"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#事务操作"}},[t._v("#")]),t._v(" 事务操作")]),t._v(" "),s("h3",{attrs:{id:"控制事务"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#控制事务"}},[t._v("#")]),t._v(" 控制事务")]),t._v(" "),s("p",[t._v("查看事务提交的方式")]),t._v(" "),s("div",{staticClass:"language-sql line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-sql"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("select")]),t._v(" @"),s("span",{pre:!0,attrs:{class:"token variable"}},[t._v("@autocommit")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br")])]),s("p",[t._v("设置事务的提交方式(只针对本次连接有效)")]),t._v(" "),s("div",{staticClass:"language-sql line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-sql"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("set")]),t._v(" @"),s("span",{pre:!0,attrs:{class:"token variable"}},[t._v("@autocommit")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br")])]),s("p",[t._v("提交事务")]),t._v(" "),s("div",{staticClass:"language-sql line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-sql"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("commit")]),t._v("\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br")])]),s("p",[t._v("回滚事务")]),t._v(" "),s("div",{staticClass:"language-sql line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-sql"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("rollback")]),t._v("\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br")])]),s("p",[t._v("开启事务")]),t._v(" "),s("div",{staticClass:"language-sql line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-sql"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("start")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("transaction")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 或者begin")]),t._v("\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br")])]),s("p",[t._v("模拟张三给李四转账事务")]),t._v(" "),s("div",{staticClass:"language-sql line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-sql"}},[s("code",[s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 开启事务")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("start")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("transaction")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("update")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("user")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("set")]),t._v(" money "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" money "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1000")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("where")]),t._v(" name "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'张三'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("update")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("user")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("set")]),t._v(" money "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" money "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("+")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1000")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("where")]),t._v(" name "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'李四'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 如果出现异常...")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 事务回滚")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("rollback")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 如果没有出现异常")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("commit")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br"),s("span",{staticClass:"line-number"},[t._v("2")]),s("br"),s("span",{staticClass:"line-number"},[t._v("3")]),s("br"),s("span",{staticClass:"line-number"},[t._v("4")]),s("br"),s("span",{staticClass:"line-number"},[t._v("5")]),s("br"),s("span",{staticClass:"line-number"},[t._v("6")]),s("br"),s("span",{staticClass:"line-number"},[t._v("7")]),s("br"),s("span",{staticClass:"line-number"},[t._v("8")]),s("br"),s("span",{staticClass:"line-number"},[t._v("9")]),s("br"),s("span",{staticClass:"line-number"},[t._v("10")]),s("br"),s("span",{staticClass:"line-number"},[t._v("11")]),s("br"),s("span",{staticClass:"line-number"},[t._v("12")]),s("br"),s("span",{staticClass:"line-number"},[t._v("13")]),s("br"),s("span",{staticClass:"line-number"},[t._v("14")]),s("br"),s("span",{staticClass:"line-number"},[t._v("15")]),s("br")])]),s("h2",{attrs:{id:"事务的四大特征"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#事务的四大特征"}},[t._v("#")]),t._v(" 事务的四大特征")]),t._v(" "),s("ol",[s("li",[t._v("原子性：事务是不可分割的最小操作单元，要么全部成功，要么全部失败。")]),t._v(" "),s("li",[t._v("隔离性：事务完成时，必须使所有的数据都保持一致状态。")]),t._v(" "),s("li",[t._v("一致性：数据库系统提交的隔离机制，保证事务在不受外部并发操作影响的独立环境下运行。")]),t._v(" "),s("li",[t._v("持久性：事务一旦提交或回滚，它对数据库中的数据的改变就是永久的。")])]),t._v(" "),s("p",[t._v("事务的4大特征，简称"),s("code",[t._v("ACID")]),t._v("。")]),t._v(" "),s("h2",{attrs:{id:"并发事务问题"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#并发事务问题"}},[t._v("#")]),t._v(" 并发事务问题")]),t._v(" "),s("p",[t._v("赃读：一个事务读到另外一个事务还没有提交的数据")]),t._v(" "),s("p",[t._v("不可重复读：一个事务先后读取同一条记录，但两次读取的数据不同，称之为不可重复读。")]),t._v(" "),s("p",[t._v('幻读：一个事务按照条件查询数据时，没有对应的数据行，但是在插入数据时，又发现这行数据 已经存在，好像出现了 "幻影"')]),t._v(" "),s("h2",{attrs:{id:"事务隔离级别"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#事务隔离级别"}},[t._v("#")]),t._v(" 事务隔离级别")]),t._v(" "),s("p",[t._v("为了解决并发事务所引发的问题，在数据库中引入了事务隔离级别。主要有以下几种：")]),t._v(" "),s("table",[s("thead",[s("tr",[s("th",{staticStyle:{"text-align":"center"}},[t._v("隔离级别")]),t._v(" "),s("th",{staticStyle:{"text-align":"center"}},[t._v("脏读")]),t._v(" "),s("th",{staticStyle:{"text-align":"center"}},[t._v("不可重复读")]),t._v(" "),s("th",{staticStyle:{"text-align":"center"}},[t._v("幻读")])])]),t._v(" "),s("tbody",[s("tr",[s("td",{staticStyle:{"text-align":"center"}},[s("code",[t._v("read uncommitted")])]),t._v(" "),s("td",{staticStyle:{"text-align":"center"}},[t._v("✅")]),t._v(" "),s("td",{staticStyle:{"text-align":"center"}},[t._v("✅")]),t._v(" "),s("td",{staticStyle:{"text-align":"center"}},[t._v("✅")])]),t._v(" "),s("tr",[s("td",{staticStyle:{"text-align":"center"}},[s("code",[t._v("read committed")])]),t._v(" "),s("td",{staticStyle:{"text-align":"center"}},[t._v("❌")]),t._v(" "),s("td",{staticStyle:{"text-align":"center"}},[t._v("✅")]),t._v(" "),s("td",{staticStyle:{"text-align":"center"}},[t._v("✅")])]),t._v(" "),s("tr",[s("td",{staticStyle:{"text-align":"center"}},[s("code",[t._v("repeatable read")]),t._v("(默认)")]),t._v(" "),s("td",{staticStyle:{"text-align":"center"}},[t._v("❌")]),t._v(" "),s("td",{staticStyle:{"text-align":"center"}},[t._v("❌")]),t._v(" "),s("td",{staticStyle:{"text-align":"center"}},[t._v("✅")])]),t._v(" "),s("tr",[s("td",{staticStyle:{"text-align":"center"}},[s("code",[t._v("serializable")])]),t._v(" "),s("td",{staticStyle:{"text-align":"center"}},[t._v("❌")]),t._v(" "),s("td",{staticStyle:{"text-align":"center"}},[t._v("❌")]),t._v(" "),s("td",{staticStyle:{"text-align":"center"}},[t._v("❌")])])])]),t._v(" "),s("p",[t._v("查看数据库隔离级别变量")]),t._v(" "),s("div",{staticClass:"language-sql line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-sql"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("show")]),t._v(" variables "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("like")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'t%_isolation'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br")])]),s("table",[s("thead",[s("tr",[s("th",{staticStyle:{"text-align":"left"}},[t._v("Variable_name")]),t._v(" "),s("th",{staticStyle:{"text-align":"left"}},[t._v("Value")])])]),t._v(" "),s("tbody",[s("tr",[s("td",{staticStyle:{"text-align":"left"}},[t._v("tx_isolation")]),t._v(" "),s("td",{staticStyle:{"text-align":"left"}},[t._v("REPEATABLE-READ")])])])]),t._v(" "),s("p",[t._v("数据库的事务隔离级别默认是"),s("code",[t._v("REPEATABLE-READ")])]),t._v(" "),s("blockquote",[s("p",[t._v("注意：事务隔离级别越高，数据越安全，但是性能越低。")])])])}),[],!1,null,null,null);s.default=n.exports}}]);